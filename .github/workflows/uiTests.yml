# This is a basic workflow to help you get started with Actions

name: Android CI - Weather Screen Tests

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the "master" branch
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  ui-tests:
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v4

      # Runs a single command using the runners shell
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      # Runs a set of commands using the runners shell
      - name: Grant execute permission for gradlew
        run: chmod +x ./gradlew
        
      - name: Enable KVM
        if: runner.os == 'Linux'
        run: |
          echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
          sudo udevadm control --reload-rules
          sudo udevadm trigger --name-match=kvm

      - name: Run UI Tests on Emulator
        uses: reactivecircus/android-emulator-runner@v2
        with:
          api-level: 36 # Specify the API level for the emulator
          target: google_apis # Or 'default', 'aosp_atd', etc. 'google_apis' includes Google Play Services.
          arch: x86_64 # Or 'x86', 'arm64-v8a' (though arm may be slower without specific runners)
          profile: Nexus 6 # Optional: specify a device profile
          create-args: "--no-window" # Optional: arguments for emulator creation
          emulator-options: "-no-snapshot-load -no-snapshot-save -no-audio -no-boot-anim -camera-back none -camera-front none" # Optional: disable features to speed up boot and reduce flakiness
          disable-animations: true # Recommended for UI tests
          script: ./gradlew connectedDebugAndroidTest # Or your specific Gradle task for UI tests, e.g., connectedDebugAndroidTest

      #- name: Upload Test Reports (Optional)
       # if: always() # Ensure this step runs even if tests fail
        #uses: actions/upload-artifact@v4
        #with:
          #name: ui-test-reports
          #path: app/build/reports/androidTests/connected/ # Adjust path to your test reports
